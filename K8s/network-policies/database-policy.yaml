# üì¶ K8s/network/network-policies.yaml

# 1Ô∏è‚É£ Default deny all traffic in the namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
spec:
  podSelector: {} # applies to all pods
  policyTypes:
    - Ingress
    - Egress

---

# 2Ô∏è‚É£ Allow frontend to talk to backend and kubelet probes
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-to-backend
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: backend
      ports:
        - protocol: TCP
          port: 5000
    - to:
        - ipBlock:
            cidr: 10.0.0.0/8 # internal cluster for probes
      ports:
        - protocol: TCP
          port: 80

---

# 3Ô∏è‚É£ Allow backend to talk to database, frontend, itself and kubelet probes
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-to-db-and-frontend
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: database
      ports:
        - protocol: TCP
          port: 5432
    - to:
        - podSelector:
            matchLabels:
              app: backend
      ports:
        - protocol: TCP
          port: 5000
    - to:
        - podSelector:
            matchLabels:
              app: frontend
      ports:
        - protocol: TCP
          port: 80
    - to:
        - ipBlock:
            cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 5000

---

# 4Ô∏è‚É£ Allow database to only accept traffic from backend pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-allow-backend
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: database
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: backend
      ports:
        - protocol: TCP
          port: 5432
    - from:
        - ipBlock:
            cidr: 10.0.0.0/8 # allow kubelet probes
      ports:
        - protocol: TCP
          port: 5432
  egress:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0 # for external access like backups
          
---

# 5Ô∏è‚É£ Allow frontend to receive traffic from outside and kubelet probes
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-allow-ingress
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
          namespaceSelector:
            matchLabels:
              app.kubernetes.io/component: controller
      ports:
        - protocol: TCP
          port: 80




# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: database-allow-backend
#   namespace: production
# spec:
#   podSelector:
#     matchLabels:
#       app: database   # applies to database pods only
#   policyTypes:
#     - Ingress
#     - Egress
#   ingress:
#     - from:
#         - podSelector:
#             matchLabels:
#               app: backend   # only backend pods
#       ports:
#         - protocol: TCP
#           port: 5432        # PostgreSQL
#   egress: [] # deny all egress
